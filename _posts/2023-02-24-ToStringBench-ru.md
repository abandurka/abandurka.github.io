---
layout: post
title:  "Неочевидное поведение интерполяции строк и метод ToString()"
date:   2023-02-19 12:00:01 +0300
categories: [DotNet, Performance]
tags:
    - .net
    - performance
---

Несколько лет назад я наткнулся на статью о ['AutoToString' Visual Studio Extension](https://davidelettieri.it/.net/visualstudio/'code/generation'/2019/12/11/auto-tostring.html). Суть его заключается в том, чтобы принудительно проставлять вызов `ToString()` на всех переменных внутри выражения. Казалось бы зачем? Сама IDE подсвечивает, что такой вызов излишний и предлагает сделать это работу компилятору за нас.

Поменять это:

```csharp
$"{{{nameof(Value)}={Value}}}"
```

На это
```csharp
$"{{{nameof(Value)}={Value.ToString()}}}"
```

Суть улучшения в том, чтобы избежать boxing операции в первом случае. Тем более, автор приводит тесты производительности, которые показывают превосходство производительности одного метода над другим.

С момента написания статьи(Dec 11, 2019) прошло немало времени и успело выйти несколько мажорных версий фрэймворка. Я решил проверить актуальность данного хака улучшения производительности кода на новых версиях .NET. Результаты оказались неожиданно приятными:

|                Method |            Runtime |   N |      Mean |      Error |    StdDev |       Rank |   Gen0 | Allocated |
|---------------------- |------------------- |---- |----------:|-----------:|----------:|-----------:|-------:|----------:|
|    ToStringWithBoxing |           .NET 5.0 | 100 | 18.257 us |  4.1766 us | 0.2289 us |   ******** | 1.9836 |   8.19 KB |
| ToStringWithoutBoxing |           .NET 5.0 | 100 |  8.499 us |  8.6948 us | 0.4766 us |          * | 2.5024 |  10.25 KB |
|    ToStringWithBoxing |           .NET 6.0 | 100 | 10.514 us | 10.0587 us | 0.5514 us |       **** | 1.4343 |   5.91 KB |
| ToStringWithoutBoxing |           .NET 6.0 | 100 | 11.516 us |  6.5178 us | 0.3573 us |     ****** | 2.4872 |  10.19 KB |
|    ToStringWithBoxing |           .NET 7.0 | 100 | 10.052 us |  7.2381 us | 0.3967 us |        *** | 1.4343 |   5.88 KB |
| ToStringWithoutBoxing |           .NET 7.0 | 100 | 10.950 us | 14.2467 us | 0.7809 us |      ***** | 2.4872 |  10.22 KB |
|    ToStringWithBoxing |      .NET Core 3.1 | 100 | 21.794 us | 16.4384 us | 0.9010 us |  ********* | 2.0142 |   8.26 KB |
| ToStringWithoutBoxing |      .NET Core 3.1 | 100 |  9.914 us |  5.3795 us | 0.2949 us |         ** | 2.5024 |  10.23 KB |
|    ToStringWithBoxing | .NET Framework 4.7 | 100 | 30.108 us | 14.1489 us | 0.7755 us | ********** | 3.2349 |   13.3 KB |
| ToStringWithoutBoxing | .NET Framework 4.7 | 100 | 15.655 us |  0.7381 us | 0.0405 us |    ******* | 2.6703 |  10.97 KB |

Приятно осознавать, что простое обновление версии фреймворка может принести незначительный прирост производительности в такой супер распространенной операции, как интерполяция строк. Исходный код тестов вы можете найти в [моем репозитории на GitHub](https://github.com/abandurka/ToStringBenchmark).
